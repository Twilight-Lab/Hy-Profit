<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Hypixel Bazaar Item Fetcher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar style for the autocomplete list */
        #autocomplete-list::-webkit-scrollbar {
            width: 8px;
        }
        #autocomplete-list::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }
        #autocomplete-list::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }
    </style>
</head>
<!-- Body remains flexible column, now the header elements are fixed again -->
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4">

    <!-- Company Name in Top Left Corner (FIXED) -->
    <div class="fixed top-4 left-4 text-xl font-bold tracking-widest pointer-events-none z-30">
        <span class="text-blue-300">Twilight</span><span class="text-white">Lab</span>
    </div>

    <!-- Back Button to Top Right Corner (FIXED) -->
    <a href="index.html" class="fixed top-4 right-4 flex items-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 z-30">
        <!-- SVG Home Icon -->
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0v-4a1 1 0 011-1h2a1 1 0 011 1v4m-6 0h6"></path>
        </svg>
        Back to Home
    </a>

    <!-- Main Content Container - Added pt-16 to push content below the fixed buttons -->
    <div class="p-6 md:p-8 w-full max-w-xl transition-all duration-300 pt-16">
        <h1 class="text-3xl font-extrabold text-center text-teal-400 mb-2">Hypixel Skyblock Bazaar <span class="text-xl">ðŸ’°</span></h1>
        <p class="text-gray-400 text-center text-sm mb-6">Start typing an item ID or name (e.g., <span class="font-mono bg-gray-700 rounded-md px-1 py-0.5 text-xs text-green-300">DIAMOND</span> or <span class="font-mono bg-gray-700 rounded-md px-1 py-0.5 text-xs text-green-300">ENCHANTED STONE</span>) to view real-time prices.</p>

        <div class="relative mb-6">
            <div class="flex items-center">
                <!-- Search Icon -->
                <svg class="absolute left-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                
                <input type="text" id="itemInput" oninput="handleInput()" placeholder="Search item name or ID..." class="w-full p-3 pl-10 border-2 border-gray-600 bg-gray-700 text-white rounded-lg placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-teal-500/50 transition duration-300 uppercase font-mono tracking-wider">
            </div>
            <div id="autocomplete-list" class="absolute z-20 w-full bg-gray-700 border border-gray-600 rounded-lg shadow-xl max-h-60 overflow-y-auto mt-1 hidden"></div>
        </div>
        
        <!-- REMOVED: bg-gray-700, rounded-xl, border-gray-600, and adjusted padding -->
        <div id="results" class="min-h-[150px] p-0 flex items-center justify-center">
            <!-- Results will be displayed here -->
            <div class="text-gray-400 text-center p-4" id="initialMessage">Loading live Bazaar data...</div>
        </div>
    </div>

    <script>
        // Global variables to store the fetched data and item list
        let BAZAAR_DATA = {};
        // ITEM_MAP stores both ID and Name for searching
        let ITEM_MAP = [];
        let ITEM_IDS = []; 

        // Debounce timer variables
        let typingTimer;
        const typingDelay = 600; // Delay in milliseconds for auto-fetch after typing stops

        const itemInput = document.getElementById('itemInput');
        const autocompleteList = document.getElementById('autocomplete-list');
        const resultsContainer = document.getElementById('results');
        const initialMessage = document.getElementById('initialMessage');
        
        /**
         * Clears previous results and shows a loading message with an enhanced spinner.
         * @param {string} message - The message to display while loading.
         */
        function showLoading(message = "Fetching data...") {
            resultsContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center w-full h-full text-center text-teal-400 py-8">
                    <svg class="animate-spin h-8 w-8 text-teal-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-lg">${message}</span>
                </div>
            `;
        }
        
        /**
         * Initializes data by fetching all products from the Hypixel Bazaar API.
         */
        async function initializeBazaarData() {
            showLoading("Loading live Bazaar data...");
            try {
                // Initial fetch to get all product IDs and data
                const response = await fetch('https://api.hypixel.net/skyblock/bazaar');
                const data = await response.json();

                if (data.success) {
                    BAZAAR_DATA = data.products;
                    ITEM_IDS = Object.keys(BAZAAR_DATA).sort();
                    
                    // Create the ITEM_MAP for dual name/ID searching
                    ITEM_MAP = ITEM_IDS.map(id => ({
                        id: id,
                        // Create a user-friendly name, which is used for display and matching
                        // Example: CARROT_ITEM becomes CARROT ITEM
                        name: id.replace(/_/g, ' ')
                    }));
                    
                    initialMessage.textContent = `Data loaded! Total items: ${ITEM_IDS.length}. Start typing now.`;
                    initialMessage.classList.remove('text-gray-400');
                    initialMessage.classList.add('text-green-400');

                    // Automatically hide the initial message after a delay
                    setTimeout(() => {
                        // Restore initial message if no search has been performed
                        if (itemInput.value.length === 0) {
                            resultsContainer.innerHTML = '<div class="text-gray-400 text-center p-4">Start searching for an item to see its real-time prices.</div>';
                        }
                    }, 3000);
                } else {
                    initialMessage.textContent = `Error fetching data: ${data.cause || 'Unknown error.'}`;
                    initialMessage.classList.add('text-red-400');
                }
            } catch (error) {
                console.error("API Fetch Error:", error);
                initialMessage.innerHTML = `
                    <strong class="text-red-400">ðŸš¨ Connection Error!</strong><br>
                    Could not connect to the Hypixel API. Please check your network connection.
                `;
            }
        }


        /**
         * Formats a number to a readable currency string.
         * @param {number} num - The number to format.
         * @returns {string} The formatted string.
         */
        function formatSkyblockCoins(num) {
            // Use Math.max(0, num) to prevent negative coin displays if there's a volume error
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(Math.max(0, num)).replace('$', '').trim();
        }

        /**
         * Formats a number to a readable integer string for large volumes.
         * @param {number} num - The number to format.
         * @returns {string} The formatted string.
         */
        function formatVolume(num) {
            return new Intl.NumberFormat('en-US').format(Math.max(0, num));
        }

        /**
         * Fetches and displays Hypixel Bazaar data for a given item ID from the cached BAZAAR_DATA.
         * @param {string} itemId - The item ID to fetch.
         */
        async function fetchBazaarData(itemId) {
            itemId = (itemId || '').trim().toUpperCase();
            if (!itemId) {
                resultsContainer.innerHTML = '<div class="text-red-400 text-center p-4">Please enter a valid item ID.</div>';
                return;
            }

            if (ITEM_IDS.length === 0) {
                resultsContainer.innerHTML = '<div class="text-yellow-400 text-center p-4">Bazaar data is still loading. Please wait a moment.</div>';
                return;
            }

            showLoading(`Looking up ${itemId.replace(/_/g, ' ')}...`);
            
            // Check if the item exists in the fetched data
            const itemData = BAZAAR_DATA[itemId];
            
            if (!itemData) {
                resultsContainer.innerHTML = `
                    <div class="text-yellow-400 text-center p-4">
                        <strong class="font-bold">${itemId}</strong> is not a valid or active Bazaar item ID.
                    </div>
                `;
                return;
            }

            const itemDisplayName = itemId.replace(/_/g, ' ');
            const quickStatus = itemData.quick_status || {};
            
            // Extract weekly volumes
            const buyMovingWeek = quickStatus.buyMovingWeek || 0; // Volume of Player Sells (Buy Orders Filled)
            const sellMovingWeek = quickStatus.sellMovingWeek || 0; // Volume of Player Buys (Sell Offers Filled)


            // Structure the data for display, including the full summaries and new volumes
            const dataToDisplay = {
                product_id: itemId,
                itemDisplayName,
                buySummary: itemData.buy_summary, // Player selling to Bazaar (Sell Orders)
                sellSummary: itemData.sell_summary, // Player buying from Bazaar (Buy Offers)
                buyMovingWeek: buyMovingWeek, // Weekly volume for Buy Orders filled (Player Sells)
                sellMovingWeek: sellMovingWeek // Weekly volume for Sell Offers filled (Player Buys)
            };

            displayResults(dataToDisplay);
        }

        /**
         * Helper function to render an order table (Buy Orders or Sell Offers).
         * @param {Array} summary - The array of orders/offers.
         * @param {boolean} isBuyOrder - True if rendering Buy Orders (Bazaar's Buy Summary / Player Sells), False for Sell Offers (Bazaar's Sell Summary / Player Buys).
         * @param {number} volumeToDisplay - The specific 7-day volume to display.
         * @param {number} marketMargin - The calculated instant flip margin (Sell Order Price - Buy Offer Price).
         * @returns {string} The HTML string for the table.
         */
        function renderOrderTable(summary, isBuyOrder, volumeToDisplay, marketMargin) {
            // isBuyOrder == true (Bazaar Buy Summary / Player Sells) -> RED (Sell Orders)
            // isBuyOrder == false (Bazaar Sell Summary / Player Buys) -> GREEN (Buy Offers)
            
            const title = isBuyOrder ? 'Sell Orders' : 'Buy Offers'; 
            
            // --- COLOR REVERTED: RED for Sell Orders, GREEN for Buy Offers ---
            const headerClass = isBuyOrder ? 'bg-red-700/50 text-red-200' : 'bg-green-700/50 text-green-200';
            
            const bestPrice = summary[0]?.pricePerUnit || 0;
            
            // Price is always yellow for visibility
            const priceClass = 'text-yellow-300'; 
            // Volume is always green for quantity
            const volumeClass = 'text-green-400'; 
            
            // --- ICON REVERTED: Fire for Sell Orders, Ice for Buy Offers ---
            const icon = isBuyOrder ? 'ðŸ”¥' : 'ðŸ§Š'; 
            
            // Format the specific volume for display
            const formattedVolume = formatVolume(volumeToDisplay);

            // Determine the volume label based on the SWAPPED data coming in:
            // If isBuyOrder=true (Sell Orders), it receives data.buyMovingWeek (Player Sells Volume). Label: "7 Day Buy Volume"
            // If isBuyOrder=false (Buy Offers), it receives data.sellMovingWeek (Player Buys Volume). Label: "7 Day Sell Volume"
            const volumeLabel = isBuyOrder ? '7 Day Buy Volume' : '7 Day Sell Volume';

            let marginHtml = '';
            
            if (isBuyOrder) {
                // Only display margin in the Sell Orders card
                const formattedMargin = formatSkyblockCoins(marketMargin);
                // Color the margin based on whether it's profitable or not
                const marginColorClass = marketMargin > 0 ? 'text-green-500' : (marketMargin < 0 ? 'text-red-500' : 'text-gray-400');
                
                marginHtml = `
                    <p class="text-xs text-gray-400 mt-2 font-mono">
                        Margin: <span class="${marginColorClass} font-bold">${formattedMargin}</span>
                    </p>
                `;
            } else {
                // Invisible spacer to ensure both cards align vertically.
                // It occupies the same space as the margin line on the Sell Orders card.
                marginHtml = `
                    <p class="text-xs text-gray-400 mt-2 font-mono opacity-0 select-none pointer-events-none">
                        &nbsp;
                    </p>
                `;
            }

            let tableRows = '';

            for (let i = 0; i < summary.length; i++) { // Loop runs for the entire summary length
                const order = summary[i];
                const price = formatSkyblockCoins(order.pricePerUnit);
                // Volume formatted without cents
                const volume = new Intl.NumberFormat('en-US').format(order.amount); 

                tableRows += `
                    <div class="grid grid-cols-2 p-2 ${i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700'} text-sm hover:bg-gray-600 transition duration-100">
                        <!-- Price value uses yellow class, text is white for label/text -->
                        <span class="text-white font-mono ${priceClass} font-semibold">${price}</span>
                        <!-- Volume value uses green class, text is white for label/text -->
                        <span class="text-right ${volumeClass} font-bold">${volume}</span>
                    </div>
                `;
            }

            if (summary.length === 0) {
                 tableRows = `<div class="p-4 text-center text-gray-400 text-sm bg-gray-700">No active orders found in this summary.</div>`;
            }
            
            return `
                <div class="flex flex-col overflow-hidden">
                    <!-- Table Header -->
                    <div class="p-3 ${headerClass} font-extrabold text-lg text-center flex items-center justify-center">
                        <span class="mr-2 text-xl">${icon}</span> ${title}
                    </div>
                    
                    <!-- Best Price Indicator (Flatter block) -->
                    <div class="p-3 text-center bg-gray-600/70">
                        <!-- Best Price Per Unit LABEL is white -->
                        <p class="text-xs uppercase text-white font-medium mb-1">Best Price Per Unit</p>
                        <!-- Price value uses yellow class -->
                        <p class="text-3xl font-black ${priceClass} mb-1 drop-shadow-lg transition duration-200">
                            ${formatSkyblockCoins(bestPrice)}
                        </p>
                        
                        <!-- 7-Day Specific Volume Line (Label is swapped to match the data passed) -->
                        <p class="text-xs text-gray-400 mt-2 font-mono">
                            ${volumeLabel}: <span class="text-teal-300 font-bold">${formattedVolume}</span>
                        </p>
                        
                        <!-- Margin Line (Only visible for Sell Orders, or spacer for Buy Offers) -->
                        ${marginHtml}
                    </div>

                    <!-- Order List -->
                    <div class="p-0">
                        <!-- Header text (Price, Volume) is white -->
                        <div class="grid grid-cols-2 text-white font-semibold uppercase text-xs px-2 py-1.5 bg-gray-700">
                            <span>Price</span>
                            <span class="text-right">Volume</span>
                        </div>
                        ${tableRows}
                    </div>
                </div>
            `;
        }


        /**
         * Displays the fetched item data in a clean, card format with new aesthetics, including weekly volume.
         * @param {object} data - The item data object containing pricing.
         */
        function displayResults(data) {
            
            // Get the best prices for calculation (first entry in each summary)
            const bestSellOrderPrice = data.buySummary[0]?.pricePerUnit || 0; // Price player receives when selling instantly
            const bestBuyOfferPrice = data.sellSummary[0]?.pricePerUnit || 0; // Price player pays when buying instantly
            
            // Calculate the instant flip margin
            const marketMargin = bestSellOrderPrice - bestBuyOfferPrice;

            resultsContainer.innerHTML = `
                <div class="w-full flex flex-col space-y-6 pt-4">
                    <!-- Item Title and Subtitle for better visual hierarchy -->
                    <div class="pb-3 border-b border-gray-600">
                        <h3 class="text-3xl font-black text-center text-teal-300 tracking-wider">
                            âœ¨ ${data.itemDisplayName}
                        </h3>
                        <p class="text-sm text-center text-gray-400 mt-1">Real-time Bazaar Order Book</p>
                    </div>

                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Buy Offers (GREEN, isBuyOrder=false) gets Player Buys Volume (sellMovingWeek). Pass margin for context. -->
                        ${renderOrderTable(data.sellSummary, false, data.sellMovingWeek, marketMargin)} 

                        <!-- Sell Orders (RED, isBuyOrder=true) gets Player Sells Volume (buyMovingWeek). Pass margin to display. -->
                        ${renderOrderTable(data.buySummary, true, data.buyMovingWeek, marketMargin)}
                    </div>
                </div>
            `;
        }


        /**
         * Handles input events for autocompletion and initiates debounced auto-fetch.
         */
        function handleInput() {
            const input = itemInput.value.trim().toUpperCase();
            
            // Clear the previous debounce timer on every keystroke
            clearTimeout(typingTimer); 

            // Clear previous suggestions
            autocompleteList.innerHTML = '';
            
            if (!input || ITEM_MAP.length === 0) {
                autocompleteList.classList.add('hidden');
                return;
            }

            // Filter ITEM_MAP: match if input INCLUDES any part of the ID OR any part of the Name.
            // This enables searching by middle words like "GOLDEN" in "ENCHANTED GOLDEN CARROT".
            const matches = ITEM_MAP.filter(item => {
                const normalizedName = item.name.toUpperCase();
                // Check if the raw ID contains the input OR the user-friendly name contains the input
                return item.id.includes(input) || normalizedName.includes(input);
            });

            if (matches.length > 0) {
                
                // 1. Prioritize matches where the item name starts exactly with the input.
                // 2. Sort remaining alphabetically by ID for consistent ordering.
                matches.sort((a, b) => {
                    const aName = a.name.toUpperCase();
                    const bName = b.name.toUpperCase();

                    const aStarts = aName.startsWith(input);
                    const bStarts = bName.startsWith(input);

                    if (aStarts && !bStarts) return -1; // A comes first
                    if (!aStarts && bStarts) return 1;  // B comes first

                    // Fallback to alphabetical sort by ID (A-Z)
                    return a.id.localeCompare(b.id);
                });


                // Limit to the top 10 results
                matches.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    
                    // Display ONLY the user-friendly name (e.g., CARROT ITEM)
                    div.innerHTML = `<span class="font-sans font-medium">${item.name}</span>`;
                    
                    div.classList.add('p-3', 'cursor-pointer', 'hover:bg-gray-600', 'transition', 'duration-150', 'text-white');
                    // Pass the raw ID back to selectAutocomplete
                    div.onclick = () => selectAutocomplete(item.id); 
                    autocompleteList.appendChild(div);
                });
                autocompleteList.classList.remove('hidden');
            } else {
                autocompleteList.classList.add('hidden');
            }

            // Set new timer for auto-fetch if typing stops and the input is a valid ID
            typingTimer = setTimeout(() => {
                // Auto-fetch is triggered only when the input matches a full, exact ITEM ID.
                if (ITEM_IDS.includes(input)) {
                    fetchBazaarData(input);
                } else {
                    // Also check if the input is an exact match for a name and find its ID
                    const exactMatch = ITEM_MAP.find(item => item.name.toUpperCase() === input);
                    if (exactMatch) {
                        // If user types the full name and stops, fetch by the corresponding ID
                        itemInput.value = exactMatch.id; // Update input to the ID before fetching
                        fetchBazaarData(exactMatch.id);
                    }
                }
            }, typingDelay);
        }

        /**
         * Handles the selection of an item from the autocomplete list.
         * Fills the input with the raw ID and immediately fetches the data.
         * @param {string} itemId - The selected item ID (raw ID).
         */
        function selectAutocomplete(itemId) {
            itemInput.value = itemId; // We set the input value to the raw ID
            autocompleteList.classList.add('hidden');
            fetchBazaarData(itemId); 
            itemInput.focus(); 
        }
        
        // Start initialization when the page loads
        window.onload = initializeBazaarData;
    </script>
</body>
</html>
